revoke delete on table "public"."comentarios" from "anon";

revoke insert on table "public"."comentarios" from "anon";

revoke references on table "public"."comentarios" from "anon";

revoke select on table "public"."comentarios" from "anon";

revoke trigger on table "public"."comentarios" from "anon";

revoke truncate on table "public"."comentarios" from "anon";

revoke update on table "public"."comentarios" from "anon";

revoke delete on table "public"."comentarios" from "authenticated";

revoke insert on table "public"."comentarios" from "authenticated";

revoke references on table "public"."comentarios" from "authenticated";

revoke select on table "public"."comentarios" from "authenticated";

revoke trigger on table "public"."comentarios" from "authenticated";

revoke truncate on table "public"."comentarios" from "authenticated";

revoke update on table "public"."comentarios" from "authenticated";

revoke delete on table "public"."comentarios" from "service_role";

revoke insert on table "public"."comentarios" from "service_role";

revoke references on table "public"."comentarios" from "service_role";

revoke select on table "public"."comentarios" from "service_role";

revoke trigger on table "public"."comentarios" from "service_role";

revoke truncate on table "public"."comentarios" from "service_role";

revoke update on table "public"."comentarios" from "service_role";

revoke delete on table "public"."gastos" from "anon";

revoke insert on table "public"."gastos" from "anon";

revoke references on table "public"."gastos" from "anon";

revoke select on table "public"."gastos" from "anon";

revoke trigger on table "public"."gastos" from "anon";

revoke truncate on table "public"."gastos" from "anon";

revoke update on table "public"."gastos" from "anon";

revoke delete on table "public"."gastos" from "authenticated";

revoke insert on table "public"."gastos" from "authenticated";

revoke references on table "public"."gastos" from "authenticated";

revoke select on table "public"."gastos" from "authenticated";

revoke trigger on table "public"."gastos" from "authenticated";

revoke truncate on table "public"."gastos" from "authenticated";

revoke update on table "public"."gastos" from "authenticated";

revoke delete on table "public"."gastos" from "service_role";

revoke insert on table "public"."gastos" from "service_role";

revoke references on table "public"."gastos" from "service_role";

revoke select on table "public"."gastos" from "service_role";

revoke trigger on table "public"."gastos" from "service_role";

revoke truncate on table "public"."gastos" from "service_role";

revoke update on table "public"."gastos" from "service_role";

revoke delete on table "public"."hogares" from "anon";

revoke insert on table "public"."hogares" from "anon";

revoke references on table "public"."hogares" from "anon";

revoke select on table "public"."hogares" from "anon";

revoke trigger on table "public"."hogares" from "anon";

revoke truncate on table "public"."hogares" from "anon";

revoke update on table "public"."hogares" from "anon";

revoke delete on table "public"."hogares" from "authenticated";

revoke insert on table "public"."hogares" from "authenticated";

revoke references on table "public"."hogares" from "authenticated";

revoke select on table "public"."hogares" from "authenticated";

revoke trigger on table "public"."hogares" from "authenticated";

revoke truncate on table "public"."hogares" from "authenticated";

revoke update on table "public"."hogares" from "authenticated";

revoke delete on table "public"."hogares" from "service_role";

revoke insert on table "public"."hogares" from "service_role";

revoke references on table "public"."hogares" from "service_role";

revoke select on table "public"."hogares" from "service_role";

revoke trigger on table "public"."hogares" from "service_role";

revoke truncate on table "public"."hogares" from "service_role";

revoke update on table "public"."hogares" from "service_role";

revoke delete on table "public"."notificaciones" from "anon";

revoke insert on table "public"."notificaciones" from "anon";

revoke references on table "public"."notificaciones" from "anon";

revoke select on table "public"."notificaciones" from "anon";

revoke trigger on table "public"."notificaciones" from "anon";

revoke truncate on table "public"."notificaciones" from "anon";

revoke update on table "public"."notificaciones" from "anon";

revoke delete on table "public"."notificaciones" from "authenticated";

revoke insert on table "public"."notificaciones" from "authenticated";

revoke references on table "public"."notificaciones" from "authenticated";

revoke select on table "public"."notificaciones" from "authenticated";

revoke trigger on table "public"."notificaciones" from "authenticated";

revoke truncate on table "public"."notificaciones" from "authenticated";

revoke update on table "public"."notificaciones" from "authenticated";

revoke delete on table "public"."notificaciones" from "service_role";

revoke insert on table "public"."notificaciones" from "service_role";

revoke references on table "public"."notificaciones" from "service_role";

revoke select on table "public"."notificaciones" from "service_role";

revoke trigger on table "public"."notificaciones" from "service_role";

revoke truncate on table "public"."notificaciones" from "service_role";

revoke update on table "public"."notificaciones" from "service_role";

revoke delete on table "public"."perfil_usuario" from "anon";

revoke insert on table "public"."perfil_usuario" from "anon";

revoke references on table "public"."perfil_usuario" from "anon";

revoke select on table "public"."perfil_usuario" from "anon";

revoke trigger on table "public"."perfil_usuario" from "anon";

revoke truncate on table "public"."perfil_usuario" from "anon";

revoke update on table "public"."perfil_usuario" from "anon";

revoke delete on table "public"."perfil_usuario" from "authenticated";

revoke insert on table "public"."perfil_usuario" from "authenticated";

revoke references on table "public"."perfil_usuario" from "authenticated";

revoke select on table "public"."perfil_usuario" from "authenticated";

revoke trigger on table "public"."perfil_usuario" from "authenticated";

revoke truncate on table "public"."perfil_usuario" from "authenticated";

revoke update on table "public"."perfil_usuario" from "authenticated";

revoke delete on table "public"."perfil_usuario" from "service_role";

revoke insert on table "public"."perfil_usuario" from "service_role";

revoke references on table "public"."perfil_usuario" from "service_role";

revoke select on table "public"."perfil_usuario" from "service_role";

revoke trigger on table "public"."perfil_usuario" from "service_role";

revoke truncate on table "public"."perfil_usuario" from "service_role";

revoke update on table "public"."perfil_usuario" from "service_role";

revoke delete on table "public"."usuario_hogar" from "anon";

revoke insert on table "public"."usuario_hogar" from "anon";

revoke references on table "public"."usuario_hogar" from "anon";

revoke select on table "public"."usuario_hogar" from "anon";

revoke trigger on table "public"."usuario_hogar" from "anon";

revoke truncate on table "public"."usuario_hogar" from "anon";

revoke update on table "public"."usuario_hogar" from "anon";

revoke delete on table "public"."usuario_hogar" from "authenticated";

revoke insert on table "public"."usuario_hogar" from "authenticated";

revoke references on table "public"."usuario_hogar" from "authenticated";

revoke select on table "public"."usuario_hogar" from "authenticated";

revoke trigger on table "public"."usuario_hogar" from "authenticated";

revoke truncate on table "public"."usuario_hogar" from "authenticated";

revoke update on table "public"."usuario_hogar" from "authenticated";

revoke delete on table "public"."usuario_hogar" from "service_role";

revoke insert on table "public"."usuario_hogar" from "service_role";

revoke references on table "public"."usuario_hogar" from "service_role";

revoke select on table "public"."usuario_hogar" from "service_role";

revoke trigger on table "public"."usuario_hogar" from "service_role";

revoke truncate on table "public"."usuario_hogar" from "service_role";

revoke update on table "public"."usuario_hogar" from "service_role";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.crear_notificacion(hogar uuid, receptor uuid, emisor uuid, tipo text, mensaje text, metadata jsonb DEFAULT '{}'::jsonb)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  nueva_id uuid;
BEGIN
  INSERT INTO notificaciones (hogar_id, usuario_id, emisor_id, tipo, mensaje, metadata)
  VALUES (hogar, receptor, emisor, tipo, mensaje, metadata)
  RETURNING id INTO nueva_id;

  RETURN nueva_id;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.crear_perfil_usuario_automatico()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  -- Insertar un nuevo perfil cuando se crea un usuario en auth.users
  INSERT INTO public.perfil_usuario (id, nombre, foto_url)
  VALUES (
    NEW.id,
    COALESCE(NEW.raw_user_meta_data->>'displayName', NEW.email),
    NEW.raw_user_meta_data->>'avatar_url'
  )
  ON CONFLICT (id) DO NOTHING;

  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.debug_auth()
 RETURNS TABLE(uid uuid, role text)
 LANGUAGE sql
 SECURITY DEFINER
AS $function$
  select auth.uid(), auth.role();
$function$
;

CREATE OR REPLACE FUNCTION public.debug_auth_context()
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
begin
  return json_build_object(
    'uid', auth.uid(),
    'role', auth.role()
  );
end;
$function$
;

CREATE OR REPLACE FUNCTION public.invitar_miembro(hogar uuid, miembro uuid, rol_in text DEFAULT 'miembro'::text)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  soy_admin boolean;
BEGIN
  -- Verificar que quien llama es admin del hogar
  SELECT EXISTS (
    SELECT 1
    FROM usuario_hogar
    WHERE hogar_id = hogar
      AND user_id = auth.uid()
      AND rol = 'admin'
  ) INTO soy_admin;

  IF NOT soy_admin THEN
    RAISE EXCEPTION 'No tienes permisos para invitar miembros a este hogar';
  END IF;

  -- Verificar que el invitado no pertenezca ya a un hogar (por tu UNIQUE(user_id))
  IF EXISTS (SELECT 1 FROM usuario_hogar WHERE user_id = miembro) THEN
    RAISE EXCEPTION 'El usuario ya pertenece a un hogar';
  END IF;

  -- Insertar invitado
  INSERT INTO usuario_hogar (hogar_id, user_id, rol)
  VALUES (hogar, miembro, COALESCE(rol_in, 'miembro'));
END;
$function$
;

CREATE OR REPLACE FUNCTION public.obtener_gastos_extendidos(hogar uuid, desde date, hasta date)
 RETURNS TABLE(id uuid, descripcion text, monto numeric, categoria text, fecha date, creado_en timestamp without time zone, usuario_nombre text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT
    g.id,
    g.descripcion,
    g.monto,
    g.categoria,
    g.fecha,
    g.creado_en,
    g.usuario_nombre
  FROM public.vista_gastos_extendida g
  WHERE g.hogar_id = hogar
    AND g.fecha BETWEEN desde AND hasta
    AND EXISTS (
      SELECT 1 FROM public.usuario_hogar uh
      WHERE uh.hogar_id = hogar
      AND uh.user_id = auth.uid()
    )
  ORDER BY g.fecha DESC;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.obtener_resumen_mensual(hogar uuid, mes integer, anio integer)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  resultado json;
BEGIN
  SELECT json_build_object(
    'total_mes', COALESCE(SUM(monto), 0),
    'por_categoria', json_object_agg(categoria, total_categoria)
  )
  INTO resultado
  FROM (
    SELECT categoria, SUM(monto) AS total_categoria
    FROM gastos
    WHERE hogar_id = hogar
    AND EXTRACT(MONTH FROM fecha) = mes
    AND EXTRACT(YEAR FROM fecha) = anio
    GROUP BY categoria
  ) AS sub;

  RETURN resultado;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.obtener_usuarios_hogar(hogar uuid)
 RETURNS TABLE(user_id uuid, email text, display_name text, rol text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$BEGIN
  RETURN QUERY
  SELECT 
    u.id AS user_id,
    u.email::text,  -- 👈 conversión explícita
    COALESCE(
      pf.nombre,
      u.raw_user_meta_data->>'displayName',
      u.raw_user_meta_data->>'display_name',
      u.raw_user_meta_data->>'full_name',
      u.email::text
    ) AS display_name,
    uh.rol::text
  FROM usuario_hogar uh
  JOIN auth.users u ON u.id = uh.user_id
  LEFT JOIN perfil_usuario pf ON pf.id = u.id
  WHERE uh.hogar_id = hogar
  ORDER BY uh.rol, display_name;
END;$function$
;



  create policy "Acceso público de lectura 1m4ctr_0"
  on "storage"."objects"
  as permissive
  for select
  to anon
using ((bucket_id = 'fotos'::text));



  create policy "Usuarios autenticados pueden leer fotos 1m4ctr_0"
  on "storage"."objects"
  as permissive
  for select
  to public
using ((bucket_id = 'fotos'::text));



  create policy "Usuarios autenticados pueden subir a fotos 1m4ctr_0"
  on "storage"."objects"
  as permissive
  for insert
  to public
with check (((bucket_id = 'fotos'::text) AND (auth.role() = 'authenticated'::text)));



  create policy "Usuarios pueden eliminar sus propias fotos 1m4ctr_0"
  on "storage"."objects"
  as permissive
  for delete
  to public
using (((bucket_id = 'fotos'::text) AND (owner = auth.uid())));



